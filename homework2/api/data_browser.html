<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DX Cluster Data Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .frequency-cell { font-family: monospace; }
        .callsign-cell { font-weight: bold; }
        .timestamp-cell { font-size: 0.9em; color: #666; }
        .api-url { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 8px; 
            font-family: monospace; 
            font-size: 0.9em; 
            margin: 10px 0;
        }
        .stats-card { transition: all 0.3s ease; }
        .stats-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .loading { display: none; }
        .error-message { display: none; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-radio"></i> DX Cluster Data Browser
            </span>
            <div class="d-flex">
                <button class="btn btn-outline-light btn-sm" onclick="refreshStats()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- API Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-heartbeat"></i> API Status</h5>
                        <span id="api-status" class="badge bg-secondary">Checking...</span>
                    </div>
                    <div class="card-body">
                        <div id="api-url" class="api-url">API Base URL: <span id="base-url">http://localhost:5000/api</span></div>
                        <small class="text-muted">Last checked: <span id="last-check">Never</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4" id="stats-section">
            <div class="col-md-3">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Spots</h6>
                                <h3 id="total-spots">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-database fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">DX Stations</h6>
                                <h3 id="dx-stations">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-globe fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Spotters</h6>
                                <h3 id="unique-spotters">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Today's Spots</h6>
                                <h3 id="spots-today">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar-day fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-search"></i> Search & Filter</h5>
                    </div>
                    <div class="card-body">
                        <form id="search-form">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="dx-call" class="form-label">DX Call</label>
                                    <input type="text" class="form-control" id="dx-call" placeholder="e.g., JA1ABC">
                                </div>
                                <div class="col-md-3">
                                    <label for="spotter-call" class="form-label">Spotter Call</label>
                                    <input type="text" class="form-control" id="spotter-call" placeholder="e.g., W1AW">
                                </div>
                                <div class="col-md-2">
                                    <label for="band" class="form-label">Band</label>
                                    <select class="form-control" id="band">
                                        <option value="">All Bands</option>
                                        <option value="160m">160m</option>
                                        <option value="80m">80m</option>
                                        <option value="40m">40m</option>
                                        <option value="20m">20m</option>
                                        <option value="17m">17m</option>
                                        <option value="15m">15m</option>
                                        <option value="12m">12m</option>
                                        <option value="10m">10m</option>
                                        <option value="6m">6m</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="limit" class="form-label">Results</label>
                                    <select class="form-control" id="limit">
                                        <option value="50">50</option>
                                        <option value="100" selected>100</option>
                                        <option value="250">250</option>
                                        <option value="500">500</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <label for="freq-min" class="form-label">Min Frequency (kHz)</label>
                                    <input type="number" class="form-control" id="freq-min" placeholder="e.g., 14000">
                                </div>
                                <div class="col-md-3">
                                    <label for="freq-max" class="form-label">Max Frequency (kHz)</label>
                                    <input type="number" class="form-control" id="freq-max" placeholder="e.g., 14350">
                                </div>
                                <div class="col-md-3">
                                    <label for="since" class="form-label">Since (hours ago)</label>
                                    <select class="form-control" id="since">
                                        <option value="">All Time</option>
                                        <option value="1">1 hour</option>
                                        <option value="6">6 hours</option>
                                        <option value="24" selected>24 hours</option>
                                        <option value="168">7 days</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="comment-search" class="form-label">Comment Contains</label>
                                    <input type="text" class="form-control" id="comment-search" placeholder="e.g., CQ DX">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-table"></i> DX Spots</h5>
                        <div>
                            <span id="result-count" class="badge bg-info">0 results</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="exportResults()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="loading text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading spots...</div>
                        </div>
                        <div class="error-message text-center p-4 text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="mt-2" id="error-text">Error loading data</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="spots-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Time</th>
                                        <th>DX Call</th>
                                        <th>Frequency</th>
                                        <th>Spotter</th>
                                        <th>Band</th>
                                        <th>Mode</th>
                                        <th>Comment</th>
                                    </tr>
                                </thead>
                                <tbody id="spots-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="row mt-3">
            <div class="col-12">
                <nav aria-label="Spots pagination">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentOffset = 0;
        let currentLimit = 100;
        let lastSearchParams = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkApiHealth();
            loadInitialData();
            
            // Set up form submission
            document.getElementById('search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                currentOffset = 0;
                searchSpots();
            });
        });

        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const statusElement = document.getElementById('api-status');
                if (response.ok && data.status === 'healthy') {
                    statusElement.textContent = 'Online';
                    statusElement.className = 'badge bg-success';
                } else {
                    statusElement.textContent = 'Offline';
                    statusElement.className = 'badge bg-danger';
                }
            } catch (error) {
                const statusElement = document.getElementById('api-status');
                statusElement.textContent = 'Error';
                statusElement.className = 'badge bg-danger';
            }
            
            document.getElementById('last-check').textContent = new Date().toLocaleTimeString();
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();
                
                document.getElementById('total-spots').textContent = data.total.total_spots.toLocaleString();
                document.getElementById('dx-stations').textContent = data.total.unique_dx_stations.toLocaleString();
                document.getElementById('unique-spotters').textContent = data.total.unique_spotters.toLocaleString();
                document.getElementById('spots-today').textContent = data.today.spots_today.toLocaleString();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadInitialData() {
            await loadStats();
            await searchSpots();
        }

        function buildSearchParams() {
            const params = new URLSearchParams();
            
            const dxCall = document.getElementById('dx-call').value.trim();
            const spotterCall = document.getElementById('spotter-call').value.trim();
            const band = document.getElementById('band').value;
            const freqMin = document.getElementById('freq-min').value;
            const freqMax = document.getElementById('freq-max').value;
            const since = document.getElementById('since').value;
            const comment = document.getElementById('comment-search').value.trim();
            const limit = document.getElementById('limit').value;
            
            if (dxCall) params.append('dx_call', dxCall);
            if (spotterCall) params.append('spotter_call', spotterCall);
            if (band) params.append('band', band);
            if (freqMin) params.append('frequency_min', freqMin);
            if (freqMax) params.append('frequency_max', freqMax);
            if (comment) params.append('comment_contains', comment);
            if (since) {
                const sinceDate = new Date(Date.now() - (parseInt(since) * 60 * 60 * 1000));
                params.append('since', sinceDate.toISOString());
            }
            
            params.append('limit', limit);
            params.append('offset', currentOffset);
            
            currentLimit = parseInt(limit);
            return params;
        }

        async function searchSpots() {
            const loading = document.querySelector('.loading');
            const errorMessage = document.querySelector('.error-message');
            const table = document.getElementById('spots-table');
            
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const params = buildSearchParams();
                lastSearchParams = Object.fromEntries(params.entries());
                
                const response = await fetch(`${API_BASE}/spots?${params}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }
                
                displaySpots(data.spots);
                updatePagination(data.pagination);
                
                loading.style.display = 'none';
                table.style.display = 'table';
                
                document.getElementById('result-count').textContent = 
                    `${data.pagination.total.toLocaleString()} results`;
                
            } catch (error) {
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
                document.getElementById('error-text').textContent = error.message;
                console.error('Error searching spots:', error);
            }
        }

        function displaySpots(spots) {
            const tbody = document.getElementById('spots-tbody');
            tbody.innerHTML = '';
            
            spots.forEach(spot => {
                const row = document.createElement('tr');
                
                const timestamp = new Date(spot.timestamp).toLocaleString();
                const frequency = parseFloat(spot.frequency).toFixed(1);
                
                row.innerHTML = `
                    <td class="timestamp-cell">${timestamp}</td>
                    <td class="callsign-cell">${spot.dx_call || ''}</td>
                    <td class="frequency-cell">${frequency}</td>
                    <td class="callsign-cell">${spot.spotter_call || ''}</td>
                    <td><span class="badge bg-secondary">${spot.band || 'N/A'}</span></td>
                    <td>${spot.mode || ''}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${spot.comment || ''}">${spot.comment || ''}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updatePagination(pagination) {
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';
            
            const totalPages = Math.ceil(pagination.total / pagination.limit);
            const currentPage = Math.floor(pagination.offset / pagination.limit) + 1;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#" onclick="navigatePage(-1)">Previous</a>';
            paginationElement.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
                paginationElement.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!pagination.has_more ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#" onclick="navigatePage(1)">Next</a>';
            paginationElement.appendChild(nextLi);
        }

        function navigatePage(direction) {
            currentOffset += direction * currentLimit;
            if (currentOffset < 0) currentOffset = 0;
            searchSpots();
        }

        function goToPage(page) {
            currentOffset = (page - 1) * currentLimit;
            searchSpots();
        }

        function refreshStats() {
            checkApiHealth();
            loadStats();
        }

        function exportResults() {
            // Simple CSV export
            const table = document.getElementById('spots-table');
            const rows = table.querySelectorAll('tr');
            let csv = '';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td, th');
                const rowData = Array.from(cells).map(cell => 
                    '"' + cell.textContent.replace(/"/g, '""') + '"'
                ).join(',');
                csv += rowData + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dx_spots_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (currentOffset === 0) { // Only auto-refresh if on first page
                searchSpots();
            }
            refreshStats();
        }, 30000);
    </script>
</body>
</html>