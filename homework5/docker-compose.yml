version: '3.8'

services:
  # DX Cluster API Server
  dx-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    image: ghcr.io/stevebuer/cs330-projects/dx-cluster-api:latest
    container_name: dx-cluster-api
    ports:
      - "8080:8080"
    environment:
      - PGHOST=${PGHOST}
      - PGDATABASE=${PGDATABASE}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGPORT=${PGPORT}
      - FLASK_ENV=${FLASK_ENV:-production}
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - dx-network
    depends_on:
      - postgres-check
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dx-api.rule=Host(`api.dx.local`)"
      - "traefik.http.services.dx-api.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # Database connectivity check service
  postgres-check:
    image: postgres:15-alpine
    container_name: dx-postgres-check
    environment:
      - PGHOST=${PGHOST}
      - PGDATABASE=${PGDATABASE}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGPORT=${PGPORT}
    command: >
      sh -c "
        until pg_isready -h $${PGHOST} -p $${PGPORT} -U $${PGUSER}; do
          echo 'Waiting for PostgreSQL...'
          sleep 2
        done
        echo 'PostgreSQL is ready!'
      "
    networks:
      - dx-network

  # Optional: Reverse proxy with Traefik
  traefik:
    image: traefik:v2.10
    container_name: dx-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8888:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - dx-network
    profiles:
      - proxy

networks:
  dx-network:
    driver: bridge
